<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
        }
        #instances {
            margin-top: 20px;
        }
        #instances ul {
            list-style-type: none;
            padding: 0;
        }
        #instances li {
            padding: 5px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
        }
        .chart-container {
            margin-top: 20px;
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <h1>Monitoring Dashboard</h1>
    <button id="createInstanceButton">Create Instance</button>
    <button id="chaosEngineeringButton">Trigger Chaos Engineering</button>
    <div id="instances">
        <h2>Instances</h2>
        <ul id="instanceList"></ul>
    </div>
    <div id="charts">
        <h2>Instance Health Charts</h2>
    </div>

    <script>
        const instanceList = document.getElementById('instanceList');
        const chartsContainer = document.getElementById('charts');
        const chartInstances = {}; 

        const colors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
        ];

        async function fetchInstances() {
            const response = await fetch('http://localhost:7000/instances');
            const instances = await response.json();
            instanceList.innerHTML = instances.map(instance => `<li>${instance.name} (Port: ${instance.port}) - ${instance.status}</li>`).join('');
            fetchHealthHistory(instances);
        }

        async function fetchHealthHistory(instances) {
            const response = await fetch('http://localhost:7000/health-history');
            const history = await response.json();

            chartsContainer.innerHTML = '';

            instances.forEach((instance, index) => {
                const instanceName = instance.name;

                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `<h3>${instanceName} Health</h3><canvas id="${instanceName}-chart"></canvas>`;
                chartsContainer.appendChild(chartContainer);

                const ctx = document.getElementById(`${instanceName}-chart`).getContext('2d');
                const instanceData = history[instanceName] || [];

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: instanceData.map(entry => new Date(entry.timestamp)),
                        datasets: [{
                            label: instanceName,
                            data: instanceData.map(entry => ({
                                x: new Date(entry.timestamp),
                                y: entry.latency !== null ? entry.latency : 0
                            })),
                            borderColor: colors[index % colors.length],
                            backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
                            fill: false,
                            pointRadius: 3,
                            borderWidth: 2,
                            pointBackgroundColor: instanceData.map(dataPoint => dataPoint.status === 'Running' ? 'green' : 'red'),
                            pointBorderColor: instanceData.map(dataPoint => dataPoint.status === 'Running' ? 'green' : 'red'),
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    tooltipFormat: 'PPpp',
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                },
                                min: new Date(new Date().getTime() - 5 * 60 * 1000),
                                max: new Date(),
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Latency (ms)',
                                },
                                ticks: {
                                    callback: (value) => {
                                        if (value === 0) return 'Dead';
                                        return value;
                                    },
                                },
                                suggestedMin: 0,
                                suggestedMax: 15,
                            },
                        },
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                            },
                        },
                    }
                });

                chartInstances[instanceName] = chart;
            });
        }

        document.getElementById('createInstanceButton').addEventListener('click', async () => {
            await fetch('http://localhost:7000/create-instance', { method: 'POST' });
            fetchInstances();
        });

        document.getElementById('chaosEngineeringButton').addEventListener('click', async () => {
            await fetch('http://localhost:7000/chaos-engineering', { method: 'POST' });
            fetchInstances();
        });

        setInterval(fetchInstances, 5000);

        fetchInstances();
    </script>
</body>
</html>
